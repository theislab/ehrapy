<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />

    <!-- Generated with Sphinx 5.3.0 and Furo 2022.12.07 -->
        <title>ehrapy.anndata.anndata_ext - ehrapy</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?digest=91d0f0d1c444bdcb17a68e833c7a53903343c195" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/override.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/sphinx_gallery.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #003262;
  --color-brand-content: #003262;
  --admonition-font-size: var(--font-size-normal);
  --admonition-title-font-size: var(--font-size-normal);
  --code-font-size: var(--font-size--small);
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">ehrapy</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../../_static/ehrapy_pure.png" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../usage/usage.html">Usage</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/io/ehrapy.io.read_csv.html">ehrapy.io.read_csv</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/io/ehrapy.io.read_h5ad.html">ehrapy.io.read_h5ad</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/io/ehrapy.io.write.html">ehrapy.io.write</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.mimic_2.html">ehrapy.data.mimic_2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.mimic_3_demo.html">ehrapy.data.mimic_3_demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.diabetes_130.html">ehrapy.data.diabetes_130</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.heart_failure.html">ehrapy.data.heart_failure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.chronic_kidney_disease.html">ehrapy.data.chronic_kidney_disease</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.breast_tissue.html">ehrapy.data.breast_tissue</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.cervical_cancer_risk_factors.html">ehrapy.data.cervical_cancer_risk_factors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.dermatology.html">ehrapy.data.dermatology</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.echocardiogram.html">ehrapy.data.echocardiogram</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.heart_disease.html">ehrapy.data.heart_disease</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.hepatitis.html">ehrapy.data.hepatitis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.statlog_heart.html">ehrapy.data.statlog_heart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.thyroid.html">ehrapy.data.thyroid</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.breast_cancer_coimbra.html">ehrapy.data.breast_cancer_coimbra</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.parkinson_dataset_with_replicated_acoustic_features.html">ehrapy.data.parkinson_dataset_with_replicated_acoustic_features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.parkinsons.html">ehrapy.data.parkinsons</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.parkinsons_disease_classification.html">ehrapy.data.parkinsons_disease_classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/data/ehrapy.data.parkinsons_telemonitoring.html">ehrapy.data.parkinsons_telemonitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.pca.html">ehrapy.preprocessing.pca</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.regress_out.html">ehrapy.preprocessing.regress_out</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.subsample.html">ehrapy.preprocessing.subsample</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.highly_variable_features.html">ehrapy.preprocessing.highly_variable_features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.winsorize.html">ehrapy.preprocessing.winsorize</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.clip_quantile.html">ehrapy.preprocessing.clip_quantile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.qc_metrics.html">ehrapy.preprocessing.qc_metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.qc_lab_measurements.html">ehrapy.preprocessing.qc_lab_measurements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.explicit_impute.html">ehrapy.preprocessing.explicit_impute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.simple_impute.html">ehrapy.preprocessing.simple_impute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.knn_impute.html">ehrapy.preprocessing.knn_impute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.miss_forest_impute.html">ehrapy.preprocessing.miss_forest_impute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.soft_impute.html">ehrapy.preprocessing.soft_impute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.iterative_svd_impute.html">ehrapy.preprocessing.iterative_svd_impute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.matrix_factorization_impute.html">ehrapy.preprocessing.matrix_factorization_impute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.nuclear_norm_minimization_impute.html">ehrapy.preprocessing.nuclear_norm_minimization_impute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.mice_forest_impute.html">ehrapy.preprocessing.mice_forest_impute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.encode.html">ehrapy.preprocessing.encode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.undo_encoding.html">ehrapy.preprocessing.undo_encoding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.log_norm.html">ehrapy.preprocessing.log_norm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.maxabs_norm.html">ehrapy.preprocessing.maxabs_norm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.minmax_norm.html">ehrapy.preprocessing.minmax_norm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.power_norm.html">ehrapy.preprocessing.power_norm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.quantile_norm.html">ehrapy.preprocessing.quantile_norm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.robust_scale_norm.html">ehrapy.preprocessing.robust_scale_norm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.scale_norm.html">ehrapy.preprocessing.scale_norm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.sqrt_norm.html">ehrapy.preprocessing.sqrt_norm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.offset_negative_values.html">ehrapy.preprocessing.offset_negative_values</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.combat.html">ehrapy.preprocessing.combat</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/preprocessing/ehrapy.preprocessing.neighbors.html">ehrapy.preprocessing.neighbors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.pca.html">ehrapy.tools.pca</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.tsne.html">ehrapy.tools.tsne</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.umap.html">ehrapy.tools.umap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.draw_graph.html">ehrapy.tools.draw_graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.diffmap.html">ehrapy.tools.diffmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.embedding_density.html">ehrapy.tools.embedding_density</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.leiden.html">ehrapy.tools.leiden</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.louvain.html">ehrapy.tools.louvain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.dendrogram.html">ehrapy.tools.dendrogram</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.dpt.html">ehrapy.tools.dpt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.paga.html">ehrapy.tools.paga</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.rank_features_groups.html">ehrapy.tools.rank_features_groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.filter_rank_features_groups.html">ehrapy.tools.filter_rank_features_groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.marker_feature_overlap.html">ehrapy.tools.marker_feature_overlap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.ingest.html">ehrapy.tools.ingest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.Translator.html">ehrapy.tools.Translator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.HPOMapper.html">ehrapy.tools.HPOMapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.MedCAT.html">ehrapy.tools.MedCAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.mc.run_unsupervised_training.html">ehrapy.tools.mc.run_unsupervised_training</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.mc.annotate_text.html">ehrapy.tools.mc.annotate_text</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.mc.get_annotation_overview.html">ehrapy.tools.mc.get_annotation_overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.ols.html">ehrapy.tools.ols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.glm.html">ehrapy.tools.glm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/tools/ehrapy.tools.kmf.html">ehrapy.tools.kmf</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.scatter.html">ehrapy.plot.scatter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.heatmap.html">ehrapy.plot.heatmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.dotplot.html">ehrapy.plot.dotplot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.tracksplot.html">ehrapy.plot.tracksplot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.violin.html">ehrapy.plot.violin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.stacked_violin.html">ehrapy.plot.stacked_violin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.matrixplot.html">ehrapy.plot.matrixplot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.clustermap.html">ehrapy.plot.clustermap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.ranking.html">ehrapy.plot.ranking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.dendrogram.html">ehrapy.plot.dendrogram</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.qc_metrics.html">ehrapy.plot.qc_metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.missing_values_matrix.html">ehrapy.plot.missing_values_matrix</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.missing_values_barplot.html">ehrapy.plot.missing_values_barplot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.missing_values_heatmap.html">ehrapy.plot.missing_values_heatmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.missing_values_dendrogram.html">ehrapy.plot.missing_values_dendrogram</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.pca.html">ehrapy.plot.pca</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.pca_loadings.html">ehrapy.plot.pca_loadings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.pca_variance_ratio.html">ehrapy.plot.pca_variance_ratio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.pca_overview.html">ehrapy.plot.pca_overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.tsne.html">ehrapy.plot.tsne</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.umap.html">ehrapy.plot.umap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.diffmap.html">ehrapy.plot.diffmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.draw_graph.html">ehrapy.plot.draw_graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.spatial.html">ehrapy.plot.spatial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.embedding.html">ehrapy.plot.embedding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.embedding_density.html">ehrapy.plot.embedding_density</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.dpt_groups_pseudotime.html">ehrapy.plot.dpt_groups_pseudotime</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.dpt_timeseries.html">ehrapy.plot.dpt_timeseries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.paga.html">ehrapy.plot.paga</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.paga_path.html">ehrapy.plot.paga_path</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.paga_compare.html">ehrapy.plot.paga_compare</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.rank_features_groups.html">ehrapy.plot.rank_features_groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.rank_features_groups_violin.html">ehrapy.plot.rank_features_groups_violin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.rank_features_groups_stacked_violin.html">ehrapy.plot.rank_features_groups_stacked_violin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.rank_features_groups_heatmap.html">ehrapy.plot.rank_features_groups_heatmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.rank_features_groups_dotplot.html">ehrapy.plot.rank_features_groups_dotplot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.rank_features_groups_matrixplot.html">ehrapy.plot.rank_features_groups_matrixplot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.rank_features_groups_tracksplot.html">ehrapy.plot.rank_features_groups_tracksplot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.ols.html">ehrapy.plot.ols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/plot/ehrapy.plot.kmf.html">ehrapy.plot.kmf</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/anndata/ehrapy.anndata.df_to_anndata.html">ehrapy.anndata.df_to_anndata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/anndata/ehrapy.anndata.anndata_to_df.html">ehrapy.anndata.anndata_to_df</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/anndata/ehrapy.anndata.move_to_obs.html">ehrapy.anndata.move_to_obs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/anndata/ehrapy.anndata.delete_from_obs.html">ehrapy.anndata.delete_from_obs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/anndata/ehrapy.anndata.move_to_x.html">ehrapy.anndata.move_to_x</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/anndata/ehrapy.anndata.type_overview.html">ehrapy.anndata.type_overview</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../tutorials/index.html">Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/notebooks/ehrapy_introduction.html">Introduction to ehrapy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/notebooks/mimic_2_introduction.html">MIMIC-II IAC Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/notebooks/mimic_2_fate.html">MIMIC-II Patient Fate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/notebooks/mimic_2_survival_analysis.html">MIMIC-II Survival Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/notebooks/diabetes_130.html">Diabetes 130 Vignette</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/notebooks/medcat.html">Extracting from free text with MedCAT</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributor Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/theislab/ehrapy/discussions">Discussions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../references.html">References</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for ehrapy.anndata.anndata_ext</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">ascii_letters</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">NamedTuple</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">anndata</span> <span class="kn">import</span> <span class="n">AnnData</span><span class="p">,</span> <span class="n">concat</span>
<span class="kn">from</span> <span class="nn">mudata</span> <span class="kn">import</span> <span class="n">MuData</span>
<span class="kn">from</span> <span class="nn">rich</span> <span class="kn">import</span> <span class="nb">print</span>
<span class="kn">from</span> <span class="nn">rich.text</span> <span class="kn">import</span> <span class="n">Text</span>
<span class="kn">from</span> <span class="nn">rich.tree</span> <span class="kn">import</span> <span class="n">Tree</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">issparse</span>

<span class="kn">from</span> <span class="nn">ehrapy</span> <span class="kn">import</span> <span class="n">logging</span> <span class="k">as</span> <span class="n">logg</span>


<span class="k">class</span> <span class="nc">BaseDataframes</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">obs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>


<div class="viewcode-block" id="df_to_anndata"><a class="viewcode-back" href="../../../usage/anndata/ehrapy.anndata.df_to_anndata.html#ehrapy.anndata.df_to_anndata">[docs]</a><span class="k">def</span> <span class="nf">df_to_anndata</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columns_obs_only</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AnnData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Transform a given pandas dataframe into an AnnData object.</span>

<span class="sd">    Note that columns containing boolean values (either 0/1 or T(t)rue/F(f)alse)</span>
<span class="sd">    will be stored as boolean columns whereas the other non numerical columns will be stored as categorical values.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: The pandas dataframe to be transformed</span>
<span class="sd">        columns_obs_only: An optional list of column names that should belong to obs only and not X</span>
<span class="sd">        index_column: The index column of obs. This can be either a column name (or its numerical index in the dataframe) or the index of the dataframe</span>

<span class="sd">    Returns:</span>
<span class="sd">        An AnnData object created from the given pandas dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># allow index 0</span>
    <span class="k">if</span> <span class="n">index_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="c1"># if the index of the dataframe is the index_column leave it as it is</span>
        <span class="k">if</span> <span class="n">index_column</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># if index column is either numerical or not the actual index name, search for index_column in the columns</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index_column</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">index_column</span> <span class="o">!=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index_column</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">index_column</span> <span class="ow">in</span> <span class="n">df_columns</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_column</span><span class="p">)</span>
            <span class="c1"># also ensure that the index is in range</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index_column</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">index_column</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_columns</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">df_columns</span><span class="p">[</span><span class="n">index_column</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IndexNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Did not find column </span><span class="si">{</span><span class="n">index_column</span><span class="si">}</span><span class="s2"> in neither index or columns!&quot;</span><span class="p">)</span>
        <span class="c1"># index_column is neither in the index or in the columns or passed as some value that could not be understood</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IndexNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Did not find column </span><span class="si">{</span><span class="n">index_column</span><span class="si">}</span><span class="s2"> in neither index or columns!&quot;</span><span class="p">)</span>

    <span class="c1"># move columns from the input dataframe to later obs</span>
    <span class="n">dataframes</span> <span class="o">=</span> <span class="n">_move_columns_to_obs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns_obs_only</span><span class="p">)</span>
    <span class="n">numerical_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataframes</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="c1"># if data is numerical only, short-circuit AnnData creation to have float dtype instead of object</span>
    <span class="n">all_num</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numerical_columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dataframes</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">dataframes</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># initializing an OrderedDict with a non-empty dict might not be intended,</span>
    <span class="c1"># see: https://stackoverflow.com/questions/25480089/right-way-to-initialize-an-ordereddict-using-its-constructor-such-that-it-retain/25480206</span>
    <span class="n">uns</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="c1"># store all numerical/non-numerical columns that are not obs only</span>
    <span class="n">binary_columns</span> <span class="o">=</span> <span class="n">_detect_binary_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">numerical_columns</span><span class="p">)</span>
    <span class="n">uns</span><span class="p">[</span><span class="s2">&quot;numerical_columns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">numerical_columns</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">binary_columns</span><span class="p">))</span>
    <span class="n">uns</span><span class="p">[</span><span class="s2">&quot;non_numerical_columns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dataframes</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">^</span> <span class="nb">set</span><span class="p">(</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;numerical_columns&quot;</span><span class="p">]))</span>

    <span class="c1"># cast non numerical obs only columns to category or bool dtype, which is needed for writing to .h5ad files</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">AnnData</span><span class="p">(</span>
        <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
        <span class="n">obs</span><span class="o">=</span><span class="n">_cast_obs_columns</span><span class="p">(</span><span class="n">dataframes</span><span class="o">.</span><span class="n">obs</span><span class="p">),</span>
        <span class="n">var</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">dataframes</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span> <span class="k">if</span> <span class="n">all_num</span> <span class="k">else</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="n">layers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;original&quot;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()},</span>
        <span class="n">uns</span><span class="o">=</span><span class="n">uns</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Transformed passed dataframe into an AnnData object with n_obs x n_vars = `</span><span class="si">{</span><span class="n">adata</span><span class="o">.</span><span class="n">n_obs</span><span class="si">}</span><span class="s2">` x `</span><span class="si">{</span><span class="n">adata</span><span class="o">.</span><span class="n">n_vars</span><span class="si">}</span><span class="s2">`.&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">adata</span></div>


<span class="k">def</span> <span class="nf">_move_columns_to_obs</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columns_obs_only</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseDataframes</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Move the given columns from the original dataframe (and therefore X) to obs.</span>

<span class="sd">    By moving these values will not get lost and will be stored in obs, but will not appear in X.</span>
<span class="sd">    This may be useful for textual values like free text.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: Pandas Dataframe to move the columns for</span>
<span class="sd">        columns_obs_only: Columns to move to obs only</span>

<span class="sd">    Returns:</span>
<span class="sd">        A modified :class:`~pd.DataFrame` object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">columns_obs_only</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns_obs_only</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns_obs_only</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ColumnNotFoundError</span><span class="p">(</span>
                <span class="s2">&quot;One or more column names passed to column_obs_only were not found in the input data. &quot;</span>
                <span class="s2">&quot;Are the column names spelled correctly?&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Added all columns to `obs`.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">BaseDataframes</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>


<div class="viewcode-block" id="anndata_to_df"><a class="viewcode-back" href="../../../usage/anndata/ehrapy.anndata.anndata_to_df.html#ehrapy.anndata.anndata_to_df">[docs]</a><span class="k">def</span> <span class="nf">anndata_to_df</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">obs_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">var_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Transform an AnnData object to a pandas dataframe.</span>

<span class="sd">    Args:</span>
<span class="sd">        adata: The AnnData object to be transformed into a pandas Dataframe</span>
<span class="sd">        layer: The layer to use for X.</span>
<span class="sd">        obs_cols: List of obs columns to add to X.</span>
<span class="sd">        var_cols: List of var columns to add to X.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The AnnData object as a pandas Dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span>
    <span class="k">if</span> <span class="n">issparse</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">obs_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ObsEmptyError</span><span class="p">(</span><span class="s2">&quot;Cannot slice columns from empty obs!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs_cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">obs_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">obs_cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs_cols</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">obs_slice</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">obs_cols</span><span class="p">]</span>
        <span class="c1"># reset index needed since we slice all or at least some columns from obs DataFrame</span>
        <span class="n">obs_slice</span> <span class="o">=</span> <span class="n">obs_slice</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">obs_slice</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added `</span><span class="si">{</span><span class="n">obs_cols</span><span class="si">}</span><span class="s2">` columns to `X`.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">var_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VarEmptyError</span><span class="p">(</span><span class="s2">&quot;Cannot slice columns from empty var!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">var_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">var_cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_cols</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">var_slice</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="n">var_cols</span><span class="p">]</span>
        <span class="c1"># reset index needed since we slice all or at least some columns from var DataFrame</span>
        <span class="n">var_slice</span> <span class="o">=</span> <span class="n">var_slice</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">var_slice</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="move_to_obs"><a class="viewcode-back" href="../../../usage/anndata/ehrapy.anndata.move_to_obs.html#ehrapy.anndata.move_to_obs">[docs]</a><span class="k">def</span> <span class="nf">move_to_obs</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span> <span class="n">to_obs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">copy_obs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AnnData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Move inplace or copy features from X to obs.</span>

<span class="sd">    Note that columns containing boolean values (either 0/1 or True(</span>
<span class="sd">    true)/False(false)) will be stored as boolean columns whereas the other non numerical columns will be stored as</span>
<span class="sd">    category.</span>

<span class="sd">    Args:</span>
<span class="sd">        adata: The AnnData object</span>
<span class="sd">        to_obs: The columns to move to obs</span>
<span class="sd">        copy_obs: The values are copied to obs (and therefore kept in X) instead of moved completely</span>

<span class="sd">    Returns:</span>
<span class="sd">        The original AnnData object with moved or copied columns from X to obs</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_obs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">to_obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">to_obs</span><span class="p">]</span>

    <span class="c1"># don&#39;t allow moving encoded columns as this could lead to inconsistent data in X and obs</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ehrapycat&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">to_obs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ObsMoveError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot move encoded columns from X to obs. Either undo encoding or remove them from the list!&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">elem</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">to_obs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Columns `</span><span class="si">{</span><span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">to_obs</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="si">}</span><span class="s2">` are not in var_names.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">copy_obs</span><span class="p">:</span>
        <span class="n">cols_to_obs_indices</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">to_obs</span><span class="p">)</span>
        <span class="n">cols_to_obs</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[:,</span> <span class="n">cols_to_obs_indices</span><span class="p">]</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cols_to_obs</span><span class="p">)</span>
        <span class="n">num_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;numerical_columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">non_num_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;non_numerical_columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">var_num</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">var_non_num</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">to_obs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">num_set</span><span class="p">:</span>
                <span class="n">var_num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">non_num_set</span><span class="p">:</span>
                <span class="n">var_non_num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">var_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">var_num</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">downcast</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">_cast_obs_columns</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cols_to_obs_indices</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">to_obs</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[:,</span> <span class="n">cols_to_obs_indices</span><span class="p">]</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">_inplace_subset_var</span><span class="p">(</span><span class="o">~</span><span class="n">cols_to_obs_indices</span><span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">updated_num_uns</span><span class="p">,</span> <span class="n">updated_non_num_uns</span><span class="p">,</span> <span class="n">num_var</span> <span class="o">=</span> <span class="n">_update_uns</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">to_obs</span><span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">num_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">num_var</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">downcast</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">_cast_obs_columns</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;numerical_columns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_num_uns</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;non_numerical_columns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_non_num_uns</span>

    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added `</span><span class="si">{</span><span class="n">to_obs</span><span class="si">}</span><span class="s2">` to `obs`.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">adata</span></div>


<div class="viewcode-block" id="delete_from_obs"><a class="viewcode-back" href="../../../usage/anndata/ehrapy.anndata.delete_from_obs.html#ehrapy.anndata.delete_from_obs">[docs]</a><span class="k">def</span> <span class="nf">delete_from_obs</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span> <span class="n">to_delete</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">AnnData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Delete features from obs.</span>

<span class="sd">    Args:</span>
<span class="sd">        adata: The AnnData object</span>
<span class="sd">        to_delete: The columns to delete from obs</span>

<span class="sd">    Returns:</span>
<span class="sd">        The original AnnData object with deleted columns from obs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_delete</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="n">to_delete</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">elem</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">to_delete</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Columns `</span><span class="si">{</span><span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">to_delete</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="si">}</span><span class="s2">` are not in obs.&quot;</span>
        <span class="p">)</span>

    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">~</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">to_delete</span><span class="p">)]]</span>

    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed `</span><span class="si">{</span><span class="n">to_delete</span><span class="si">}</span><span class="s2">` from `obs`.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">adata</span></div>


<div class="viewcode-block" id="move_to_x"><a class="viewcode-back" href="../../../usage/anndata/ehrapy.anndata.move_to_x.html#ehrapy.anndata.move_to_x">[docs]</a><span class="k">def</span> <span class="nf">move_to_x</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span> <span class="n">to_x</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AnnData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Move features from obs to X inplace.</span>

<span class="sd">    Args:</span>
<span class="sd">        adata: The AnnData object</span>
<span class="sd">        to_x: The columns to move to X</span>
<span class="sd">        copy: Whether to return a copy or not</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new AnnData object with moved columns from obs to X. This should not be used for datetime columns currently.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">elem</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">to_x</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Columns `</span><span class="si">{</span><span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">to_x</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="si">}</span><span class="s2">` are not in obs.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">to_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">to_x</span><span class="p">]</span>

    <span class="n">cols_present_in_x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cols_not_in_x</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">to_x</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">):</span>
            <span class="n">cols_present_in_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols_not_in_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cols_present_in_x</span><span class="p">:</span>
        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Columns `</span><span class="si">{</span><span class="n">cols_present_in_x</span><span class="si">}</span><span class="s2">` are already in X. Skipped moving `</span><span class="si">{</span><span class="n">cols_present_in_x</span><span class="si">}</span><span class="s2">` to X. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;If you want to permanently delete these columns from obs, please use the function delete_from_obs().&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">cols_not_in_x</span><span class="p">:</span>
        <span class="n">new_adata</span> <span class="o">=</span> <span class="n">concat</span><span class="p">([</span><span class="n">adata</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cols_not_in_x</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">new_adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">~</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cols_not_in_x</span><span class="p">)]]</span>
        <span class="c1"># update uns (copy maybe: could be a costly operation but reduces reference cycles)</span>
        <span class="c1"># users might save those as separate AnnData object and this could be unexpected behaviour if we dont copy</span>
        <span class="n">num_columns_moved</span><span class="p">,</span> <span class="n">non_num_columns_moved</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_update_uns</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">cols_not_in_x</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">new_adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;numerical_columns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;numerical_columns&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">num_columns_moved</span>
        <span class="n">new_adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;non_numerical_columns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;non_numerical_columns&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">non_num_columns_moved</span>
        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added `</span><span class="si">{</span><span class="n">cols_not_in_x</span><span class="si">}</span><span class="s2">` features to `X`.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_adata</span> <span class="o">=</span> <span class="n">adata</span>

    <span class="k">return</span> <span class="n">new_adata</span></div>


<span class="k">def</span> <span class="nf">get_column_indices</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span> <span class="n">col_names</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Fetches the column indices in X for a given list of column names</span>

<span class="sd">    Args:</span>
<span class="sd">        adata: :class:`~anndata.AnnData` object</span>
<span class="sd">        col_names: Column names to extract the indices for</span>

<span class="sd">    Returns:</span>
<span class="sd">        Set of column indices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col_names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_names</span><span class="p">]</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">:</span>
            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">indices</span>


<span class="k">def</span> <span class="nf">get_column_values</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Fetches the column values for a specific index from X</span>

<span class="sd">    Args:</span>
<span class="sd">        adata: :class:`~anndata.AnnData` object</span>
<span class="sd">        indices: The index to extract the values for</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`~numpy.ndarray` object containing the column values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<div class="viewcode-block" id="type_overview"><a class="viewcode-back" href="../../../usage/anndata/ehrapy.anndata.type_overview.html#ehrapy.anndata.type_overview">[docs]</a><span class="k">def</span> <span class="nf">type_overview</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">MuData</span> <span class="o">|</span> <span class="n">AnnData</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sort_reversed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="sd">&quot;&quot;&quot;Prints the current state of an :class:`~anndata.AnnData` or :class:`~mudata.MuData` object in a tree format.</span>

<span class="sd">    Output could be printed in sorted format by using one of `dtype`, `order`, `num_cats` or `None`, which sorts by data type, lexicographical order,</span>
<span class="sd">    number of unique values (excluding NaN&#39;s) and unsorted respectively. Note that sorting by `num_cats` only affects</span>
<span class="sd">    encoded variables currently and will display unencoded vars unsorted.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: :class:`~anndata.AnnData` or :class:`~mudata.MuData` object to display</span>
<span class="sd">        sort_by: How the tree output should be sorted. One of `dtype`, `order`, `num_cats` or None (defaults to None -&gt; unsorted)</span>
<span class="sd">        sort_reversed: Whether to sort in reversed order or not</span>

<span class="sd">    Example:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            import ehrapy as ep</span>

<span class="sd">            adata = ep.dt.mimic_2(encode=True)</span>
<span class="sd">            ep.anndata_ext.type_overview(adata)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">):</span>
        <span class="n">_adata_type_overview</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">,</span> <span class="n">sort_reversed</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">MuData</span><span class="p">):</span>
        <span class="n">_mudata_type_overview</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">,</span> <span class="n">sort_reversed</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">EhrapyRepresentationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unable to present object of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">. Can only display AnnData or MuData objects!&quot;</span>
        <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_adata_type_overview</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sort_reversed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="sd">&quot;&quot;&quot;Display the :class:`~anndata.AnnData object in its current state (encoded and unencoded variables, obs)</span>

<span class="sd">    Args:</span>
<span class="sd">        adata: The :class:`~anndata.AnnData object to display</span>
<span class="sd">        sort_by: Whether to sort output or not</span>
<span class="sd">        sort_reversed: Whether to sort output in reversed order or not</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[b green]Variable names for AnnData object with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> obs and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> vars&quot;</span><span class="p">,</span>
        <span class="n">guide_style</span><span class="o">=</span><span class="s2">&quot;underline2 bright_blue&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;var_to_encoding&quot;</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">original_values</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;original_values_categoricals&quot;</span><span class="p">]</span>
        <span class="n">branch</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot; Encoded variables&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;b green&quot;</span><span class="p">)</span>
        <span class="n">dtype_dict</span> <span class="o">=</span> <span class="n">_infer_dtype_per_encoded_var</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">original_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">original_values</span><span class="p">)</span>
        <span class="c1"># sort encoded vars by lexicographical order of original values</span>
        <span class="k">if</span> <span class="n">sort_by</span> <span class="o">==</span> <span class="s2">&quot;order&quot;</span><span class="p">:</span>
            <span class="n">encoded_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">original_values</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">reverse</span><span class="o">=</span><span class="n">sort_reversed</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">categorical</span> <span class="ow">in</span> <span class="n">encoded_list</span><span class="p">:</span>
                <span class="n">branch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[blue]</span><span class="si">{</span><span class="n">categorical</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">dtype_dict</span><span class="p">[</span><span class="n">categorical</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> categories;&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; [green]</span><span class="si">{</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;var_to_encoding&#39;</span><span class="p">][</span><span class="n">categorical</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2"> [blue]encoded; [green]original data type: [blue]</span><span class="si">{</span><span class="n">dtype_dict</span><span class="p">[</span><span class="n">categorical</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="c1"># sort encoded vars by data type of the original values or the number of unique values in original data (excluding NaNs)</span>
        <span class="k">elif</span> <span class="n">sort_by</span> <span class="o">==</span> <span class="s2">&quot;dtype&quot;</span> <span class="ow">or</span> <span class="n">sort_by</span> <span class="o">==</span> <span class="s2">&quot;num_cats&quot;</span><span class="p">:</span>
            <span class="n">sorted_by_type</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">var</span><span class="p">:</span> <span class="n">_type</span>
                <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">_type</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">dtype_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span> <span class="k">if</span> <span class="n">sort_by</span> <span class="o">==</span> <span class="s2">&quot;dtype&quot;</span> <span class="k">else</span> <span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="n">sort_reversed</span>
                <span class="p">)</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">categorical</span> <span class="ow">in</span> <span class="n">sorted_by_type</span><span class="p">:</span>
                <span class="n">branch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[blue]</span><span class="si">{</span><span class="n">categorical</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">sorted_by_type</span><span class="p">[</span><span class="n">categorical</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> categories;&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; [green]</span><span class="si">{</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;var_to_encoding&#39;</span><span class="p">][</span><span class="n">categorical</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2"> [blue]encoded; [green]original data type: [blue]</span><span class="si">{</span><span class="n">sorted_by_type</span><span class="p">[</span><span class="n">categorical</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="c1"># display in unsorted order</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">encoded_list</span> <span class="o">=</span> <span class="n">original_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">categorical</span> <span class="ow">in</span> <span class="n">encoded_list</span><span class="p">:</span>
                <span class="n">branch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[blue]</span><span class="si">{</span><span class="n">categorical</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">dtype_dict</span><span class="p">[</span><span class="n">categorical</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> categories;&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; [green]</span><span class="si">{</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;var_to_encoding&#39;</span><span class="p">][</span><span class="n">categorical</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2"> [blue]encoded; [green]original data type: [blue]</span><span class="si">{</span><span class="n">dtype_dict</span><span class="p">[</span><span class="n">categorical</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
    <span class="n">branch_num</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Text</span><span class="p">(</span><span class="s2">&quot; Unencoded variables&quot;</span><span class="p">),</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;b green&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sort_by</span> <span class="o">==</span> <span class="s2">&quot;order&quot;</span><span class="p">:</span>
        <span class="n">var_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="n">sort_reversed</span><span class="p">)</span>
        <span class="n">_sort_by_order_or_none</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">branch_num</span><span class="p">,</span> <span class="n">var_names</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sort_by</span> <span class="o">==</span> <span class="s2">&quot;dtype&quot;</span><span class="p">:</span>
        <span class="n">var_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">_sort_by_type</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">branch_num</span><span class="p">,</span> <span class="n">var_names</span><span class="p">,</span> <span class="n">sort_reversed</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">var_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">_sort_by_order_or_none</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">branch_num</span><span class="p">,</span> <span class="n">var_names</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sort_by</span><span class="p">:</span>
        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Displaying AnnData object in sorted mode. Note that this might not be the exact same order of the variables in X or var are stored!&quot;</span>
        <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_mudata_type_overview</span><span class="p">(</span>
    <span class="n">mudata</span><span class="p">:</span> <span class="n">MuData</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sort_reversed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="sd">&quot;&quot;&quot;Display the :class:`~mudata.MuData object in its current state (:class:`~anndata.AnnData objects with obs, shapes)</span>

<span class="sd">    Args:</span>
<span class="sd">        mudata: The :class:`~mudata.MuData object to display</span>
<span class="sd">        sort: Whether to sort output or not</span>
<span class="sd">        sort_reversed: Whether to sort output in reversed order or not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[b green]Variable names for AnnData object with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mudata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> obs, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mudata</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> vars and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2"> modalities</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">guide_style</span><span class="o">=</span><span class="s2">&quot;underline2 bright_blue&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">modalities</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">reverse</span><span class="o">=</span><span class="n">sort_reversed</span><span class="p">)</span> <span class="k">if</span> <span class="n">sort</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">modalities</span><span class="p">:</span>
        <span class="n">branch</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[b green]</span><span class="si">{</span><span class="n">mod</span><span class="si">}</span><span class="s2">: [not b blue]n_vars x n_obs: </span><span class="si">{</span><span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span><span class="o">.</span><span class="n">n_vars</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span><span class="o">.</span><span class="n">n_obs</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">branch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[blue]obs: [black]</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_single_quote_string</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">branch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[blue]layers: [black]</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">layer</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_sort_by_order_or_none</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">var_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Add branches to tree for sorting by order or unsorted.&quot;&quot;&quot;</span>
    <span class="n">var_names_val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">other_vars</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">other_vars</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ehrapycat&quot;</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">var_names_val</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">other_vars</span><span class="p">)</span>
            <span class="n">unique_categoricals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span> <span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">infer_dtype</span><span class="p">(</span><span class="n">unique_categoricals</span><span class="p">)</span>
            <span class="n">branch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[blue]</span><span class="si">{</span><span class="n">other_vars</span><span class="si">}</span><span class="s2"> -&gt; [green]data type: [blue]</span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_sort_by_type</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">var_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">sort_reversed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sort tree output by datatype&quot;&quot;&quot;</span>
    <span class="n">tmp_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">var_names_val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">other_vars</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">other_vars</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ehrapycat&quot;</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">var_names_val</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">other_vars</span><span class="p">)</span>
            <span class="n">unique_categoricals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span> <span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">infer_dtype</span><span class="p">(</span><span class="n">unique_categoricals</span><span class="p">)</span>
            <span class="n">tmp_dict</span><span class="p">[</span><span class="n">other_vars</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_type</span>

    <span class="n">sorted_by_type</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">var</span><span class="p">:</span> <span class="n">_type</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">_type</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tmp_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="n">sort_reversed</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">sorted_by_type</span><span class="p">:</span>
        <span class="n">branch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[blue]</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> -&gt; [green]data type: [blue]</span><span class="si">{</span><span class="n">sorted_by_type</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_infer_dtype_per_encoded_var</span><span class="p">(</span><span class="n">encoded_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">original_values</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Infer dtype of each encoded varibale of an AnnData object.&quot;&quot;&quot;</span>
    <span class="n">dtype_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">categorical</span> <span class="ow">in</span> <span class="n">encoded_list</span><span class="p">:</span>
        <span class="n">unique_categoricals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">original_values</span><span class="p">[</span><span class="n">categorical</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">categorical_type</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">infer_dtype</span><span class="p">(</span><span class="n">unique_categoricals</span><span class="p">)</span>
        <span class="n">num_unique_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">unique_categoricals</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="n">dtype_dict</span><span class="p">[</span><span class="n">categorical</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">categorical_type</span><span class="p">,</span> <span class="n">num_unique_values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dtype_dict</span>


<span class="k">def</span> <span class="nf">_single_quote_string</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="sd">&quot;&quot;&quot;Single quote a string to inject it into f-strings, since backslashes cannot be in double f-strings.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>


<span class="k">def</span> <span class="nf">_assert_encoded</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NotEncodedError</span><span class="p">(</span><span class="s2">&quot;The AnnData object has not yet been encoded.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">AssertionError</span>


<span class="k">def</span> <span class="nf">get_numeric_vars</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Fetches the column names for numeric variables in X.</span>

<span class="sd">    Args:</span>
<span class="sd">        adata: :class:`~anndata.AnnData` object</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of column numeric column names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_assert_encoded</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;numerical_columns&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">assert_numeric_vars</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span> <span class="nb">vars</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="n">num_vars</span> <span class="o">=</span> <span class="n">get_numeric_vars</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">num_vars</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Some selected vars are not numeric&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">set_numeric_vars</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">vars</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AnnData</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Sets the column names for numeric variables in X.</span>

<span class="sd">    Args:</span>
<span class="sd">        adata: :class:`~anndata.AnnData` object</span>
<span class="sd">        values: Matrix containing the replacement values</span>
<span class="sd">        vars: List of names of the numeric variables to replace. If `None` they will be detected using :func:`~ehrapy.preprocessing.get_numeric_vars`.</span>
<span class="sd">        copy: Whether to return a copy with the normalized data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`~anndata.AnnData` object with updated X</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_assert_encoded</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">vars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="n">get_numeric_vars</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">assert_numeric_vars</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="nb">vars</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;values must be numeric (current dtype is </span><span class="si">{</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="n">n_values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">n_values</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">vars</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of values (</span><span class="si">{</span><span class="n">n_values</span><span class="si">}</span><span class="s2">) does not match number of vars (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">vars_idx</span> <span class="o">=</span> <span class="n">get_column_indices</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="nb">vars</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_values</span><span class="p">):</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span> <span class="n">vars_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>

    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column names for numeric variables </span><span class="si">{</span><span class="nb">vars</span><span class="si">}</span><span class="s2"> were replaced.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">adata</span>


<span class="k">def</span> <span class="nf">_update_uns</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span> <span class="n">moved_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">to_x</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Updates .uns of adata to reflect the changes made on the object by moving columns from X to obs or vice versa.</span>

<span class="sd">    1.) Moving `col1` from `X` to `obs`: `col1` is either numerical or non_numerical, so delete it from the corresponding entry in `uns`</span>
<span class="sd">    2.) Moving `col1` from `obs` to `X`: `col1` is either numerical or non_numerical, so add it to the corresponding entry in `uns`</span>

<span class="sd">    Args:</span>
<span class="sd">        adata: class:`~anndata.AnnData` object</span>
<span class="sd">        moved_columns: List of column names to be moved</span>
<span class="sd">        to_x: Whether to move from `obs` to `X` or vice versa</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`~anndata.AnnData` object with updated .uns</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">moved_columns_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">moved_columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">to_x</span><span class="p">:</span>  <span class="c1"># moving from `X` to `obs`, delete it from the corresponding entry in `uns`.</span>
        <span class="n">num_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;numerical_columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">non_num_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;non_numerical_columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">var_num</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">moved_columns_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">num_set</span><span class="p">:</span>
                <span class="n">var_num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                <span class="n">num_set</span> <span class="o">-=</span> <span class="p">{</span><span class="n">var</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">non_num_set</span><span class="p">:</span>
                <span class="n">non_num_set</span> <span class="o">-=</span> <span class="p">{</span><span class="n">var</span><span class="p">}</span>
        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added `</span><span class="si">{</span><span class="n">moved_columns</span><span class="si">}</span><span class="s2">` columns to `X`.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">num_set</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">non_num_set</span><span class="p">),</span> <span class="n">var_num</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># moving from `obs` to `X`, add it to the corresponding entry in `uns`.</span>
        <span class="n">all_moved_non_num_columns</span> <span class="o">=</span> <span class="n">moved_columns_set</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">all_moved_num_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">moved_columns_set</span> <span class="o">^</span> <span class="n">all_moved_non_num_columns</span><span class="p">)</span>
        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added `</span><span class="si">{</span><span class="n">moved_columns</span><span class="si">}</span><span class="s2">` columns to `obs`.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_moved_num_columns</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_moved_non_num_columns</span><span class="p">),</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_detect_binary_columns</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">numerical_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Detect all columns that contain only 0 and 1 (besides NaNs).</span>

<span class="sd">    Args:</span>
<span class="sd">        df: The dataframe to check.</span>
<span class="sd">        numerical_columns: All numerical columns of the dataframe.</span>

<span class="sd">    Returns:</span>
<span class="sd">            List of column names that are binary (containing only 0 and 1 (+NaNs))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">binary_columns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">numerical_columns</span><span class="p">:</span>
        <span class="c1"># checking for float and int as well as NaNs (this is safe since checked columns are numericals only)</span>
        <span class="c1"># only columns that contain at least one 0 and one 1 are counted as binary (or 0.0/1.0)</span>
        <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">binary_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">binary_columns</span>


<span class="k">def</span> <span class="nf">_cast_obs_columns</span><span class="p">(</span><span class="n">obs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Cast non numerical obs columns to either category or bool.</span>
<span class="sd">    Args:</span>
<span class="sd">        obs: Obs of an AnnData object</span>

<span class="sd">    Returns:</span>
<span class="sd">        The type casted obs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># only cast non numerical columns</span>
    <span class="n">object_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="c1"># type cast each non numerical column to either bool (if possible) or category else</span>
    <span class="n">obs</span><span class="p">[</span><span class="n">object_columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">object_columns</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">obs_name</span><span class="p">:</span> <span class="n">obs_name</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">obs_name</span><span class="p">))</span><span class="o">.</span><span class="n">issubset</span><span class="p">({</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">})</span>
        <span class="k">else</span> <span class="n">obs_name</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;bool&quot;</span><span class="p">),</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">obs</span>


<span class="k">def</span> <span class="nf">generate_anndata</span><span class="p">(</span>
    <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">X_type</span><span class="o">=</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">,</span>
    <span class="n">X_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">obsm_types</span><span class="p">:</span> <span class="n">Collection</span> <span class="o">=</span> <span class="p">(</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span>
    <span class="n">varm_types</span><span class="p">:</span> <span class="n">Collection</span> <span class="o">=</span> <span class="p">(</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span>
    <span class="n">layers_types</span><span class="p">:</span> <span class="n">Collection</span> <span class="o">=</span> <span class="p">(</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span>
    <span class="n">include_nlp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AnnData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generates a predefined AnnData with random values.</span>

<span class="sd">    Args:</span>
<span class="sd">        shape: Shape of the X matrix.</span>
<span class="sd">        X_type: Type of the X matrix.</span>
<span class="sd">        X_dtype: Data type of the X matrix.</span>
<span class="sd">        obsm_types: Types of the obsm matrices.</span>
<span class="sd">        varm_types: Types of the varm matrices.</span>
<span class="sd">        layers_types: Types of additional layers.</span>
<span class="sd">        include_nlp: Whether to include diseases for NLP in all of X, obs and var.</span>
<span class="sd">                     Sets the X_dtype to object by default and overwrites the passed X_dtype.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A specified AnnData object.</span>

<span class="sd">    Example:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            import ehrapy as ep</span>

<span class="sd">            adata = ep.ad.generate_anndata((2, 2), include_nlp=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">example_diseases</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;diabetes melitus&quot;</span><span class="p">,</span> <span class="s2">&quot;breast cancer&quot;</span><span class="p">,</span> <span class="s2">&quot;dementia&quot;</span><span class="p">,</span> <span class="s2">&quot;pneumonia&quot;</span><span class="p">]</span>

    <span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">shape</span>
    <span class="n">obs_names</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;patient</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">var_names</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;feature</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_generate_typed_df</span><span class="p">(</span><span class="n">n_values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nlp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generates a typed DataFrame with categoricals and numericals.</span>

<span class="sd">        Args:</span>
<span class="sd">            n_values: Number of values to generate per type.</span>
<span class="sd">            index: Name of the index column.</span>
<span class="sd">            nlp: Whether to include disease names.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Pandas DataFrame with the specified number of values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">letters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">ascii_letters</span><span class="p">),</span> <span class="s2">&quot;U1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_values</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">letters</span><span class="p">):</span>
            <span class="n">letters</span> <span class="o">=</span> <span class="n">letters</span><span class="p">[:</span> <span class="n">n_values</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># Make sure categories are repeated</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">cat</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="n">n_values</span><span class="p">)),</span>
                <span class="n">cat_ordered</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="n">n_values</span><span class="p">),</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">int64</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">n_values</span><span class="p">),</span>
                <span class="n">float64</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n_values</span><span class="p">),</span>
                <span class="n">uint8</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint8&quot;</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">nlp</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;nlp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">example_diseases</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">n_values</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="n">obs</span> <span class="o">=</span> <span class="n">_generate_typed_df</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">obs_names</span><span class="p">,</span> <span class="n">nlp</span><span class="o">=</span><span class="n">include_nlp</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">_generate_typed_df</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">var_names</span><span class="p">,</span> <span class="n">nlp</span><span class="o">=</span><span class="n">include_nlp</span><span class="p">)</span>

    <span class="n">obs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">cat</span><span class="o">=</span><span class="s2">&quot;obs_cat&quot;</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">var</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">cat</span><span class="o">=</span><span class="s2">&quot;var_cat&quot;</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">X_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">include_nlp</span><span class="p">:</span>
            <span class="n">X_np_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X_np_array</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">el</span><span class="p">:</span> <span class="p">[</span><span class="n">el</span><span class="p">],</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">example_diseases</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">M</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_np_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X_type</span><span class="p">(</span><span class="n">X_np_array</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">X_dtype</span><span class="p">)</span>

    <span class="n">obsm</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="mi">50</span><span class="p">)),</span>
        <span class="n">sparse</span><span class="o">=</span><span class="n">sparse</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csr&quot;</span><span class="p">),</span>
        <span class="n">df</span><span class="o">=</span><span class="n">_generate_typed_df</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">obs_names</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">obsm</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obsm</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">obsm_types</span><span class="p">}</span>
    <span class="n">varm</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">50</span><span class="p">)),</span>
        <span class="n">sparse</span><span class="o">=</span><span class="n">sparse</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csr&quot;</span><span class="p">),</span>
        <span class="n">df</span><span class="o">=</span><span class="n">_generate_typed_df</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">var_names</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">varm</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">varm</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">varm_types</span><span class="p">}</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">)),</span> <span class="n">sparse</span><span class="o">=</span><span class="n">sparse</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csr&quot;</span><span class="p">))</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">layers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">layers_types</span><span class="p">}</span>
    <span class="n">obsp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">)),</span> <span class="n">sparse</span><span class="o">=</span><span class="n">sparse</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csr&quot;</span><span class="p">))</span>
    <span class="n">varp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">)),</span> <span class="n">sparse</span><span class="o">=</span><span class="n">sparse</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csr&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_generate_vstr_recarray</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">n</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        <span class="n">letters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ascii_letters</span><span class="p">))</span>
        <span class="n">gen_word</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">gen_word</span><span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">lengths</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">gen_word</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)])</span><span class="o">.</span><span class="n">to_records</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">column_dtypes</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">uns</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">O_recarray</span><span class="o">=</span><span class="n">_generate_vstr_recarray</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="n">nested</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">scalar_str</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">,</span>
            <span class="n">scalar_int</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
            <span class="n">scalar_float</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
            <span class="n">nested_further</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">)),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">include_nlp</span><span class="p">:</span>
        <span class="n">X_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>

    <span class="n">adata</span> <span class="o">=</span> <span class="n">AnnData</span><span class="p">(</span>
        <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
        <span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span>
        <span class="n">var</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
        <span class="n">obsm</span><span class="o">=</span><span class="n">obsm</span><span class="p">,</span>
        <span class="n">varm</span><span class="o">=</span><span class="n">varm</span><span class="p">,</span>
        <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
        <span class="n">obsp</span><span class="o">=</span><span class="n">obsp</span><span class="p">,</span>
        <span class="n">varp</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">X_dtype</span><span class="p">,</span>
        <span class="n">uns</span><span class="o">=</span><span class="n">uns</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated an AnnData object with n_obs x n_vars = `</span><span class="si">{</span><span class="n">adata</span><span class="o">.</span><span class="n">n_obs</span><span class="si">}</span><span class="s2">` x `</span><span class="si">{</span><span class="n">adata</span><span class="o">.</span><span class="n">n_vars</span><span class="si">}</span><span class="s2">`.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">adata</span>


<span class="k">class</span> <span class="nc">NotEncodedError</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">ColumnNotFoundError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">IndexNotFoundError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">ObsEmptyError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">VarEmptyError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">ObsMoveError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">EhrapyRepresentationError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2021, Lukas Heumos, Theislab
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/scripts/furo.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/design-tabs.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>